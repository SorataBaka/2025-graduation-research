<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Label Correction Suite v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple transition for hover */
        tbody tr:hover { background-color: #f9fafb; }

        /* Fix table header */
        .table-container {
            max-height: 75vh;
            overflow-y: auto;
        }
        thead th {
            position: sticky;
            top: 0;
            background-color: #f3f4f6; /* bg-gray-100 */
            z-index: 10;
        }

        /* Style for the bulk action bar */
        #bulk-action-bar {
            position: sticky;
            top: 41px; /* Height of the header row */
            z-index: 9;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8">

    <div class="max-w-screen-2xl mx-auto">

        <!-- Header -->
        <div class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-gray-800">Label Correction Suite v2.1</h1>
            <p class="text-gray-600">Load, filter, search, and bulk-correct your LLM-generated labels.</p>
        </div>

        <div class="flex flex-col md:flex-row md:space-x-6">

            <!-- Sidebar (Filters & Controls) -->
            <div class="md:w-1/4 mb-6 md:mb-0">
                <div class="bg-white p-6 rounded-lg shadow-lg space-y-6">

                    <!-- File Loader -->
                    <div>
                        <label for="file-loader" class="block text-sm font-medium text-gray-700 mb-2">1. Load Data File</label>
                        <input type="file" id="file-loader" accept=".json" class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-md file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100 cursor-pointer"/>
                        <p class="text-xs text-gray-500 mt-1">Upload the `data_for_suite.json` file.</p>
                    </div>

                    <!-- Filters -->
                    <div>
                        <label for="cluster-filter" class="block text-sm font-medium text-gray-700 mb-2">2. Filter by Cluster</label>
                        <select id="cluster-filter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Clusters</option>
                        </select>
                    </div>

                    <div>
                        <label for="label-filter" class="block text-sm font-medium text-gray-700 mb-2">3. Filter by Label</label>
                        <select id="label-filter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Labels</option>
                            <!-- UPDATED: 1 is Relevant, 0 is Irrelevant -->
                            <option value="1">Relevant (1)</option>
                            <option value="0">Irrelevant (0)</option>
                        </select>
                    </div>

                    <div>
                        <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-2">4. Filter by Status</label>
                        <select id="status-filter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Items</option>
                            <option value="uncorrected">Uncorrected</option>
                            <option value="corrected">Corrected</option>
                        </select>
                    </div>

                    <!-- Search Bar -->
                    <div>
                        <label for="search-bar" class="block text-sm font-medium text-gray-700 mb-2">5. Search Content</label>
                        <input type="text" id="search-bar" placeholder="Enter keywords..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>


                    <!-- Export Button -->
                    <div>
                        <label for="export-button" class="block text-sm font-medium text-gray-700 mb-2">6. Export Data</label>
                        <button id="export-button" disabled class="w-full py-2 px-4 bg-gray-400 text-white font-semibold rounded-md shadow-sm cursor-not-allowed">
                            Export Corrected Data
                        </button>
                        <p class="text-xs text-gray-500 mt-1">Downloads a new JSON file with all your changes.</p>
                    </div>

                </div>
            </div>

            <!-- Main Content (Data Table) -->
            <div class="md:w-3/4">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <div id="stats" class="mb-4 text-sm text-gray-600">
                        Please load a file to begin.
                    </div>
                    <div class="table-container border rounded-lg">
                        <table class="w-full text-sm text-left text-gray-700">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th scope="col" class="p-3 w-12">
                                        <input type="checkbox" id="select-all-checkbox" title="Select all visible items" class="rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-500">
                                    </th>
                                    <th scope="col" class="p-3 w-16">ID</th>
                                    <th scope="col" class="p-3 w-20">Cluster</th>
                                    <th scope="col" class="p-3 w-20">Prob.</th>
                                    <th scope="col" class="p-3 w-1/2">Content</th>
                                    <th scope="col" class="p-3 w-24">Current Label</th>
                                    <th scope="col" class="p-3 w-40">Actions</th>
                                </tr>
                            </thead>
                            <!-- Bulk Action Bar -->
                            <tbody id="bulk-action-bar" class="hidden">
                                <tr class="bg-blue-50 border-b">
                                    <td colspan="7" class="p-3">
                                        <div class="flex items-center space-x-4">
                                            <span id="bulk-select-count" class="text-sm font-medium text-blue-800">0 items selected</span>
                                            <!-- UPDATED: Buttons call corrected IDs -->
                                            <button id="bulk-set-relevant" class="py-1 px-3 text-xs font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">Set as Relevant (1)</button>
                                            <button id="bulk-set-irrelevant" class="py-1 px-3 text-xs font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700">Set as Irrelevant (0)</button>
                                            <button id="bulk-revert" class="py-1 px-3 text-xs font-medium rounded-md shadow-sm text-gray-800 bg-yellow-400 hover:bg-yellow-500">Revert Selected</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                            <tbody id="data-table-body" class="divide-y">
                                <!-- Rows will be injected by JavaScript -->
                                <tr id="placeholder-row">
                                    <td colspan="7" class="p-6 text-center text-gray-400">No data loaded.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global State ---
        let globalData = [];
        let currentFilteredData = [];
        let selectedItems = new Set();

        // --- UPDATED MAP: 1 = Relevant, 0 = Irrelevant ---
        const CLASS_MAP = { 1: "Relevant", 0: "Irrelevant" };

        // Updated Colors to match new IDs (1 gets blue, 0 gets purple)
        const LABEL_COLORS = {
            1: "bg-blue-100 text-blue-800",
            0: "bg-purple-100 text-purple-800"
        };
        const STATUS_COLORS = {
            uncorrected: "bg-white",
            corrected: "bg-green-50"
        };
        const ACTION_BUTTON_CLASSES = "py-1 px-3 text-xs font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-1";
        const FIX_BUTTON_CLASSES = "bg-red-500 text-white hover:bg-red-600 focus:ring-red-500";
        const REVERT_BUTTON_CLASSES = "bg-yellow-400 text-gray-800 hover:bg-yellow-500 focus:ring-yellow-500";


        // --- DOM Elements ---
        const fileLoader = document.getElementById('file-loader');
        const clusterFilter = document.getElementById('cluster-filter');
        const labelFilter = document.getElementById('label-filter');
        const statusFilter = document.getElementById('status-filter');
        const searchBar = document.getElementById('search-bar');
        const exportButton = document.getElementById('export-button');
        const tableBody = document.getElementById('data-table-body');
        const statsDisplay = document.getElementById('stats');
        const placeholderRow = document.getElementById('placeholder-row');

        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const bulkActionBar = document.getElementById('bulk-action-bar');
        const bulkSelectCount = document.getElementById('bulk-select-count');
        const bulkSetRelevant = document.getElementById('bulk-set-relevant');
        const bulkSetIrrelevant = document.getElementById('bulk-set-irrelevant');
        const bulkRevert = document.getElementById('bulk-revert');

        // --- Event Listeners ---
        fileLoader.addEventListener('change', handleFileLoad);
        clusterFilter.addEventListener('change', renderTable);
        labelFilter.addEventListener('change', renderTable);
        statusFilter.addEventListener('change', renderTable);
        searchBar.addEventListener('input', renderTable); // Fuzzy search
        exportButton.addEventListener('click', handleExport);

        // Bulk action listeners
        selectAllCheckbox.addEventListener('change', handleSelectAll);
        tableBody.addEventListener('change', handleRowCheckbox); // Event delegation

        // UPDATED: Bulk Set Relevant passes 1, Irrelevant passes 0
        bulkSetRelevant.addEventListener('click', () => handleBulkFix(1));
        bulkSetIrrelevant.addEventListener('click', () => handleBulkFix(0));
        bulkRevert.addEventListener('click', handleBulkRevert);

        // --- Logic ---

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    globalData = JSON.parse(e.target.result);
                    if (!Array.isArray(globalData) || globalData.length === 0) {
                        throw new Error("Data is not a valid JSON array or is empty.");
                    }

                    // --- VALIDATION: Check for 'content' field ---
                    const firstItem = globalData[0];
                    if (!('id' in firstItem && 'cluster' in firstItem && 'content' in firstItem && 'relevant' in firstItem && 'status' in firstItem)) {
                         throw new Error("JSON is missing required fields: id, cluster, content, label, status.");
                    }

                    placeholderRow.classList.add('hidden');
                    populateFilters();
                    renderTable();
                    exportButton.disabled = false;
                    exportButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    exportButton.classList.add('bg-green-600', 'hover:bg-green-700');
                } catch (err) {
                    statsDisplay.textContent = `Error: ${err.message}`;
                    globalData = [];
                }
            };
            reader.readAsText(file);
        }

        function populateFilters() {
            clusterFilter.innerHTML = '<option value="all">All Clusters</option>';
            const clusters = new Set(globalData.map(item => item.cluster));
            const sortedClusters = Array.from(clusters).sort((a, b) => a - b);

            for (const clusterId of sortedClusters) {
                const option = document.createElement('option');
                option.value = clusterId;
                option.textContent = clusterId === -1 ? "Noise (-1)" : `Cluster ${clusterId}`;
                clusterFilter.appendChild(option);
            }
        }

        function renderTable() {
            // 1. Get filter values
            const clusterVal = clusterFilter.value;
            const labelVal = labelFilter.value;
            const statusVal = statusFilter.value;
            const searchVal = searchBar.value.toLowerCase(); // Search value

            // 2. Apply filters
            currentFilteredData = globalData.filter(item => {
                const clusterMatch = clusterVal === 'all' || item.cluster.toString() === clusterVal;
                const labelMatch = labelVal === 'all' || item.relevant.toString() === labelVal;
                const statusMatch = statusVal === 'all' || item.status === statusVal;
                // --- SEARCH LOGIC ---
                const searchMatch = searchVal === '' || (item.content && item.content.toLowerCase().includes(searchVal));

                return clusterMatch && labelMatch && statusMatch && searchMatch;
            });

            // 3. Clear table
            tableBody.innerHTML = '';

            // 4. Update stats
            updateStats(currentFilteredData.length, globalData.length);

            // 5. Update "Select All" checkbox state
            selectAllCheckbox.checked = currentFilteredData.length > 0 && currentFilteredData.every(item => selectedItems.has(item.id));
            selectAllCheckbox.indeterminate = currentFilteredData.length > 0 &&
                                              currentFilteredData.some(item => selectedItems.has(item.id)) &&
                                              !selectAllCheckbox.checked;


            // 6. Render rows
            if (currentFilteredData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="p-6 text-center text-gray-400">No items match your filters.</td></tr>';
                return;
            }

            const fragment = document.createDocumentFragment();
            for (const item of currentFilteredData) {
                const row = document.createElement('tr');
                row.className = `${STATUS_COLORS[item.status]} transition-colors duration-150 ease-in-out`;

                const labelName = CLASS_MAP[item.relevant] || 'Unknown';
                const labelColor = LABEL_COLORS[item.relevant] || 'bg-gray-100';

                // --- Use 'content' field ---
                const truncatedText = (item.content.length > 1000) ? item.content.substring(0, 1000) + '...' : item.content;

                // Create Action Button
                const actionButton = document.createElement('button');
                actionButton.className = `${ACTION_BUTTON_CLASSES}`;

                if (item.status === 'uncorrected') {
                    // UPDATED: Flip logic based on new map
                    const targetLabel = item.relevant === 1 ? 0 : 1;
                    actionButton.textContent = `Set to ${CLASS_MAP[targetLabel]} (${targetLabel})`;
                    actionButton.classList.add(...FIX_BUTTON_CLASSES.split(' '));
                } else {
                    actionButton.textContent = `Revert to ${CLASS_MAP[item.original_label]}`;
                    actionButton.classList.add(...REVERT_BUTTON_CLASSES.split(' '));
                }

                actionButton.onclick = () => handleLabelFix(item.id);

                const isChecked = selectedItems.has(item.id);

                row.innerHTML = `
                    <td class="p-3">
                        <input type="checkbox" class="row-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-500" data-id="${item.id}" ${isChecked ? 'checked' : ''}>
                    </td>
                    <td class="p-3 font-medium text-gray-500">${item.id}</td>
                    <td class="p-3 font-semibold">${item.cluster}</td>
                    <td class="p-3 text-gray-600">${item.probability.toFixed(4)}</td>
                    <td class="p-3 text-gray-800">${truncatedText}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${labelColor}">
                            ${labelName} (${item.relevant})
                        </span>
                    </td>
                    <td class="p-3"></td>
                `;

                row.lastElementChild.appendChild(actionButton);
                fragment.appendChild(row);
            }
            tableBody.appendChild(fragment);
        }

        function updateStats(filteredCount, totalCount) {
            const correctedCount = globalData.filter(d => d.status === 'corrected').length;
            statsDisplay.innerHTML = `
                Showing <strong class="text-blue-600">${filteredCount}</strong> of
                <strong class="text-gray-800">${totalCount}</strong> items. |
                <strong class="text-green-600">${correctedCount}</strong> items corrected.
            `;
        }

        // --- Single Item Fix ---
        function handleLabelFix(id) {
            const item = globalData.find(d => d.id === id);
            if (!item) return;

            if (item.status === 'uncorrected') {
                // UPDATED: Flip logic. If currently 1, make 0. If 0, make 1.
                itemrelevant = item.relevant === 1 ? 0 : 1;
                item.status = 'corrected';
            } else {
                itemrelevant = item.original_label; // Revert to original
                item.status = 'uncorrected';
            }

            renderTable(); // Re-render the whole table to reflect change
            updateBulkActionBar(); // Update selection status
        }

        // --- Bulk Action Logic ---
        function handleRowCheckbox(event) {
            if (!event.target.classList.contains('row-checkbox')) return;

            const checkbox = event.target;
            const id = parseInt(checkbox.dataset.id, 10);

            if (checkbox.checked) {
                selectedItems.add(id);
            } else {
                selectedItems.delete(id);
            }
            updateBulkActionBar();

            // Update select-all checkbox state
            selectAllCheckbox.checked = currentFilteredData.length > 0 && currentFilteredData.every(item => selectedItems.has(item.id));
            selectAllCheckbox.indeterminate = currentFilteredData.length > 0 &&
                                              currentFilteredData.some(item => selectedItems.has(item.id)) &&
                                              !selectAllCheckbox.checked;
        }

        function handleSelectAll(event) {
            const isChecked = event.target.checked;
            // Only select/deselect the *currently visible* filtered items
            for (const item of currentFilteredData) {
                if (isChecked) {
                    selectedItems.add(item.id);
                } else {
                    selectedItems.delete(item.id);
                }
            }
            renderTable(); // Re-render to show all checkboxes as checked/unchecked
            updateBulkActionBar();
        }

        function updateBulkActionBar() {
            const count = selectedItems.size;
            if (count > 0) {
                bulkActionBar.classList.remove('hidden');
                bulkSelectCount.textContent = `${count} item(s) selected`;
            } else {
                bulkActionBar.classList.add('hidden');
            }
        }

        function handleBulkFix(newLabel) {
            let itemsChanged = 0;
            for (const id of selectedItems) {
                const item = globalData.find(d => d.id === id);
                if (item) {
                    item.relevant = newLabel;
                    item.status = 'corrected';
                    itemsChanged++;
                }
            }
            console.log(`Applied label ${newLabel} to ${itemsChanged} items.`);
            selectedItems.clear();
            renderTable();
            updateBulkActionBar();
        }

        function handleBulkRevert() {
            let itemsChanged = 0;
            for (const id of selectedItems) {
                const item = globalData.find(d => d.id === id);
                if (item) {
                    item.relevant = item.original_label;
                    item.status = 'uncorrected';
                    itemsChanged++;
                }
            }
            console.log(`Reverted ${itemsChanged} items.`);
            selectedItems.clear();
            renderTable();
            updateBulkActionBar();
        }

        function handleExport() {
            const dataStr = JSON.stringify(globalData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'data_corrected.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

    </script>
</body>
</html>